---
title: "Adding math support to a Gatsby MDX blog"
date: "2021-06-14"
authors: ["nicky"]
tags: ["math", "Gatsby"]
cover: "./cover.jpg"
---

import { MathBlock } from "./../../../src/components/MathBlock";

<!-- Photo by <a href="https://unsplash.com/@jeshoots?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">JESHOOTS.COM</a> on <a href="https://unsplash.com/s/photos/math?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText">Unsplash</a> -->

I wanted to add support to display equations on my blog.
A popular tool to achieve this is [KaTeX](https://katex.org/).

The goal is being able to write a string in the TeX syntax inside an `.mdx` file,
and a pretty math equation shows up on the rendered page.

My blog uses [`gatsby-plugin-mdx`](https://github.com/gatsbyjs/gatsby/tree/master/packages/gatsby-plugin-mdx) to be able to use `.mdx` files.

To achieve the goal of writing KaTeX blocks in mdx and getting pretty equations to show up, several things need to happen.

`gatsby-plugin-mdx` allows you to pass `remark` and `rehype` plugins it will use internally.

## Pinpoint the math sections in mdx

I used [`remark-math`](https://www.npmjs.com/package/remark-math) for this.
It takes your markdown, looks for the relevant math sections, and marks them as such.

An inline math section is opened with a single dollar sign, and ended by an other single dollar sign `$`.  
A math section that should be a block (so: start on a new line) is opened and closed by double dollar signs `$$`.

```mdx title=index.mdx
Some math on the same line: $T_n = a + (n-1)d$

Or, some math in a block

$$
T_n = a + (n-1)d
$$
```

The way markdown works has to do with [Abstract syntax trees](https://en.wikipedia.org/wiki/Abstract_syntax_tree).
They're terribly complex at times, but also very fascinating, and very powerful tools.

`remark-math` manipulates that tree in such a way that your inline math turns into an `inlineMath` node,
and your block math turns into a `math` node.

At the end of the `mdx` pipeline, HTML is rendered.  
The inline math blocks will turn into `span`s with a class of `math-inline`.  
A math block will turn into a `div` with a class of `math-display`.

The content of those HTML-elements will be a string with the KaTeX you wrote in the mdx file.

So `$T_n = a + (n-1)d$` turns into `<span class="math math-inline">T_n = a + (n-1)d</span>`

While the block

```mdx title=index.mdx
$$
T_n = a + (n-1)d
$$
```

Turns into `<div class="math math-display">T_n = a + (n-1)d</div>`

### Wiring up remark-math

<Aside variant="danger">

Make sure to install version 3 of `remark-math` if you are using `gatsby-plugin-mdx`.
The mdx plugin uses version 10 of `remark`, while version 4 of `remark-math` requires version 13 of `remark`.

YAY dependencies!

```bash
npm i remark-math@3.0.1
# or
yarn add remark-math@3.0.1
```

</Aside>

Install the `remark-math` plugin, and add it to the configuration option of `gatsby-plugin-mdx` in `gatsby-config.js`.

```js title=gatsby-config.js hl=7
module.exports = {
  // --- snip ---
  plugins: [
    {
      resolve: "gatsby-plugin-mdx",
      options: {
        remarkPlugins: [require("remark-math")],
      },
    },
    // --- snip ---
  ],
};
```

## Doing something with that information

There are several ways to continue from here.
Wichever way you choose, adding the required KaTeX CSS file whenever math is rendered is crucial.

<Aside variant="danger">

The KaTeX CSS file needs to be imported on a page to render the math correctly.

You can do this manually, in every mdx file, or in a layout file, or in `gatsby-browser.js`,...

For example, via the import style in a `.mdx` or `.js` file

```
import "katex/dist/katex.min.css"
```

Or via the require style inside `gatsby-browser.js`

```
require("katex/dist/katex.min.css")
```

Or a `<link>` tag in an HTML file:

```
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
```

</Aside>

### Option 1: a Rehype plugin

While a remark plugin like `remark-math` does work on the AST of the mdx **before** it turned into HTML.

A rehype plugin does work **after** that HTML is generated and changes it.

You can use [`rehype-katex`](https://www.npmjs.com/package/rehype-katex) for this.

It takes in those `<span class="math-inline">` and `<div class="math-display">` and turns the string of KaTeX you wrote
into something that's ready to be rendered into a beautiful equation.
It just needs some of that CSS.

#### Wiring up rehype-katex

Install the `rehype-katex` plugin, and add it to the configuration option of `gatsby-plugin-mdx` in `gatsby-config.js`.

```js title=gatsby-config.js hl=8
module.exports = {
  // --- snip ---
  plugins: [
    {
      resolve: "gatsby-plugin-mdx",
      options: {
        remarkPlugins: [require("remark-math")],
        rehypePlugins: [require("rehype-katex")],
      },
    },
    // --- snip ---
  ],
};
```

If you chose option 1, you're done!
Pretty math, yay!

### Option 2: a React component

I like the React workflow, so this is the option I chose for this blog.

It's a bit more flexible, I take in those `<span class="math-inline">` and `<div class="math-display">`,
and give the string to a React component to render correctly.
Should I ever want to use it outside of mdx, I can.

The React package I went with is [@matejmazur/react-katex
](https://www.npmjs.com/package/@matejmazur/react-katex).
It has a `<TeX />` component that can turn the string of raw KaTeX into a form that's ready to turn into a pretty equation on your screen.

<Aside variant="info">

I also chose this method because I wanted to create a custom component.
Give it pop ✨ with some custom CSS and add some extra features like giving a math block a title.

</Aside>

#### Using react-katex

Mdx allows you to intercept the HTML that gets rendered and add to or replace it.

This is the mechanism we'll use to intercept those `<span class="math-inline">` and `<div class="math-display">` tags,
and give the contents to the `<TeX />` component.

The `<MdxProvider />` component from `"@mdx-js/react"` allows this.
If you already have one of those in your app that wraps the mdx files you want to write math in, great!

If not, you can add one in Gatsby's [`wrapRootElement`](https://www.gatsbyjs.com/docs/reference/config-files/gatsby-browser/#wrapRootElement) in both `gatsby-browser.js` and `gatsby-ssr.js`.
Or, in the [layout component](https://www.gatsbyjs.com/plugins/gatsby-plugin-mdx/#default-layouts) the mdx file will use.

Yes, I know, there are _a lot_ of moving parts here.

```js title=MdxLayout.js
import React from "react";
import TeX from "@matejmazur/react-katex";
import { MDXProvider } from "@mdx-js/react";

const components = {
  div: (props) => {
    if (props.className.includes("math-display")) {
      import("katex/dist/katex.min.css");
      return <Tex block math={props.children} />;
    }
    return <div {...props} />;
  },
  span: (props) => {
    if (props.className.includes("math-inliney")) {
      import("katex/dist/katex.min.css");
      return <Tex math={props.children} />;
    }
    return <span {...props} />;
  },
};

export default function MdXLayout(props) {
  return <MDXProvider components={components}>{props.children}</MDXProvider>;
}
```

## Demo

For this blog, I chose the option that uses a React component.

I created a specialized `<MathBlock />` component that handles math blocks,
and gives it some extra capabilities you can specify inside mdx, by adding options next to the opening `$$`.

<Aside variant="success">

Pretty math blocks that look like my code blocks! ✨✨

</Aside>

Inline math expressions are sent straight to the `<TeX />` component.

$a$ = first item  
$l$ = last item  
$n$ = amount of items  
$d$ = common difference

Input:

```mdx title=index.mdx
Some inline math, coming right up. $T_n = a + (n-1)d$
```

Output:

Some inline math, coming right up. $T_n = a + (n-1)d$

### Using a `MathBlock` explicitly

The MathBlock component can be used in two ways,
either by passing a KaTeX string to the `math` prop,
or by including the KaTeX string in between the opening and closing tags.

#### Via the `math` prop.

Input:

<!-- prettier-ignore -->
```mdx title=index.mdx
import { MathBlock } from "./../src/components/MathBlock";
<MathBlock title="Arithmetic progression sum" math="S_n = \frac{n(a + l)}{2}" />
```

Output:

<MathBlock title="Arithmetic progression sum" math="S_n = \frac{n(a + l)}{2}" />

#### Via `children`.

Input:

<!-- prettier-ignore -->
```mdx title=index.mdx
import { MathBlock } from "./../src/components/MathBlock";
<MathBlock title="Arithmetic progression sum">

S_n = \frac{n(2a + (n-1)d)}{2}

</MathBlock>
```

Output:

<MathBlock title="Arithmetic progression sum">

S_n = \frac{n(2a + (n-1)d)}{2}

</MathBlock>

### Using `$$` signs in mdx

#### A vanilla block

Input:

```mdx title=index.mdx numberLines
$$
S_n = \frac{n(2a + (n-1)d)}{2}
$$
```

Output:

$$
S_n = \frac{n(2a + (n-1)d)}{2}
$$

#### With a meta string

Input:

<!-- prettier-ignore -->
```mdx title=index.mdx numberLines
$$ title=Arithmetic-progression-sum
S_n = \frac{n(a + l)}{2}
\newline
S_n = \frac{n(2a + (n-1)d)}{2}
$$
```

Output:

<!-- prettier-ignore -->
$$ title=Arithmetic-progression-sum
S_n = \frac{n(a + l)}{2}
\newline
S_n = \frac{n(2a + (n-1)d)}{2}
$$

<Aside variant="info">

Because of the method I chose to parse that string after the opening `$$`,
the `title` value is not able to have spaces in it.
I could rectify this with a little effort,
but I'm happy with the way it is right now.

</Aside>
